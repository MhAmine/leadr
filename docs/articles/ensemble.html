<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ensembles • leadr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="Ensembles">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">leadr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ensemble.html">Ensembles</a>
    </li>
    <li>
      <a href="../articles/introduction.html">Introduction</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://github.com/tmastny/leadr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Ensembles</h1>
                        <h4 class="author">Tim Mastny</h4>
            
            <h4 class="date">2018-03-07</h4>
          </div>

    
    
<div class="contents">
<p>This vignette demonstrates advanced features of <code>leadr</code>, applied to building an ensemble.</p>
<div id="ensembles" class="section level2">
<h2 class="hasAnchor">
<a href="#ensembles" class="anchor"></a>Ensembles</h2>
<p>Ensembles come in two flavors<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>. The first idea is an averaging ensemble.</p>
<p><img src="model%20averaging.png" width="648" style="display: block; margin: auto;"></p>
<p>A set of models make predictions, and you average the predictions (or possibly the classification probabilities).</p>
<p>Empirically, a better technique is blended or stacked ensembles:</p>
<p><img src="blended.png" width="648" style="display: block; margin: auto;"></p>
<p>Here, data is split into k-folds. The model is trained on k-1 folds, then evaluated on each holdout. Combined, each holdout set recovers the original data set. Therefore, the holdout predictions form the new ensemble feature.</p>
<p><code>leadr</code> has some basic tools that help build these type of blended models.</p>
</div>
<div id="the-task" class="section level2">
<h2 class="hasAnchor">
<a href="#the-task" class="anchor"></a>The Task</h2>
<p>We will build an ensemble for the iris dataset, which is a multiclass classification dataset. Other packages such as <a href="https://github.com/zachmayer/caretEnsemble">caretEnsemble</a> do not yet <a href="https://github.com/zachmayer/caretEnsemble/pull/191">support</a> multiclass ensembles. <code>leadr</code> fills this niche nicely.</p>
<p>First, let’s build a list of models.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(purrr)
<span class="kw">library</span>(caret)
<span class="kw">library</span>(leadr)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">folds &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/caret/topics/createDataPartition">createFolds</a></span>(iris<span class="op">$</span>Species, <span class="dt">k =</span> <span class="dv">5</span>, <span class="dt">returnTrain =</span> <span class="ot">TRUE</span>)
control &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/caret/topics/trainControl">trainControl</a></span>(<span class="dt">method =</span> <span class="st">'cv'</span>, <span class="dt">index =</span> folds, <span class="dt">savePredictions =</span> <span class="st">'final'</span>)

mapped_list &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(
  <span class="kw">c</span>(<span class="st">'rf'</span>, <span class="st">'glmnet'</span>),
  <span class="op">~</span><span class="kw"><a href="http://www.rdocumentation.org/packages/caret/topics/train">train</a></span>(
    Species <span class="op">~</span><span class="st"> </span>.,
    <span class="dt">data =</span> iris,
    <span class="dt">method =</span> .,
    <span class="dt">trControl =</span> control
  )
)</code></pre></div>
<p>We explicitly define the cross-validation index, because blending requires that each model is trained on the same set of folds.</p>
<p>We can also specify additional models using <code>caretEnsemble</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(caretEnsemble)
ensemble_list &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/caretEnsemble/topics/caretList">caretList</a></span>(
  Species <span class="op">~</span><span class="st"> </span>.,
  <span class="dt">data =</span> iris,
  <span class="dt">trControl =</span> control,
  <span class="dt">methodList =</span> <span class="kw">c</span>(<span class="st">'rpart'</span>, <span class="st">'knn'</span>)
)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">models &lt;-<span class="st"> </span><span class="kw">c</span>(mapped_list, ensemble_list)
<span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">walk</a></span>(models, board)
<span class="kw"><a href="../reference/board.html">board</a></span>()
<span class="co">#&gt; # A tibble: 4 x 13</span>
<span class="co">#&gt;    rank    id dir     model  metric score public method   num group index </span>
<span class="co">#&gt;   &lt;dbl&gt;  &lt;id&gt; &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;</span>
<span class="co">#&gt; 1    1.     2 models… glmnet Accur… 0.973     NA cv       10.    1. &lt;list…</span>
<span class="co">#&gt; 2    1.     4 models… knn    Accur… 0.973     NA cv       10.    1. &lt;list…</span>
<span class="co">#&gt; 3    3.     1 models… rf     Accur… 0.953     NA cv       10.    1. &lt;list…</span>
<span class="co">#&gt; 4    4.     3 models… rpart  Accur… 0.947     NA cv       10.    1. &lt;list…</span>
<span class="co">#&gt; # ... with 2 more variables: tune &lt;list&gt;, seeds &lt;list&gt;</span></code></pre></div>
</div>
<div id="submodel-selection" class="section level2">
<h2 class="hasAnchor">
<a href="#submodel-selection" class="anchor"></a>Submodel Selection</h2>
<p>We also want to evaluate the models that go into our ensemble. In general, we want to use two different criteria.</p>
<p>First, we want to maximize accuracy, as measured by the 5-fold cross-validation that we build our models on. Second, we want to minimize the prediction correlation. Suppose two sets of model predictions have similar accuracy scores, are not very correlated. This means that each model learned something different about the dataset, and would likely benefit from an ensemble.</p>
<p><code>caret</code> offers some nice tools to see these criteria:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">results &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/caret/topics/resamples">resamples</a></span>(models)
<span class="kw">summary</span>(results)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; summary.resamples(object = results)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Models: Model1, Model2, rpart, knn </span>
<span class="co">#&gt; Number of resamples: 5 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Accuracy </span>
<span class="co">#&gt;             Min.   1st Qu.    Median      Mean   3rd Qu.      Max. NA's</span>
<span class="co">#&gt; Model1 0.8666667 0.9666667 0.9666667 0.9533333 0.9666667 1.0000000    0</span>
<span class="co">#&gt; Model2 0.9333333 0.9666667 0.9666667 0.9733333 1.0000000 1.0000000    0</span>
<span class="co">#&gt; rpart  0.9000000 0.9333333 0.9666667 0.9466667 0.9666667 0.9666667    0</span>
<span class="co">#&gt; knn    0.9000000 0.9666667 1.0000000 0.9733333 1.0000000 1.0000000    0</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Kappa </span>
<span class="co">#&gt;        Min. 1st Qu. Median Mean 3rd Qu. Max. NA's</span>
<span class="co">#&gt; Model1 0.80    0.95   0.95 0.93    0.95 1.00    0</span>
<span class="co">#&gt; Model2 0.90    0.95   0.95 0.96    1.00 1.00    0</span>
<span class="co">#&gt; rpart  0.85    0.90   0.95 0.92    0.95 0.95    0</span>
<span class="co">#&gt; knn    0.85    0.95   1.00 0.96    1.00 1.00    0</span>

<span class="kw"><a href="http://www.rdocumentation.org/packages/caret/topics/resamples">modelCor</a></span>(results)
<span class="co">#&gt;           Model1    Model2     rpart       knn</span>
<span class="co">#&gt; Model1 1.0000000 0.8669214 0.8846517 0.9355852</span>
<span class="co">#&gt; Model2 0.8669214 1.0000000 0.5345225 0.6416889</span>
<span class="co">#&gt; rpart  0.8846517 0.5345225 1.0000000 0.9861169</span>
<span class="co">#&gt; knn    0.9355852 0.6416889 0.9861169 1.0000000</span>
<span class="kw">splom</span>(results)</code></pre></div>
<p><img src="ensemble_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<p>Some of our models are very correlated, which is to be expected for a simple data set.</p>
<p>The next step as described in the introductory diagram, is to create a new feature for each model from the out of fold predictions. <code>leadr</code> has a nice helper function for this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">blended &lt;-<span class="st"> </span><span class="kw"><a href="../reference/oof_grab.html">oof_grab</a></span>(models)
blended
<span class="co">#&gt; # A tibble: 150 x 5</span>
<span class="co">#&gt;    value  value1 value2 value3 Species</span>
<span class="co">#&gt;    &lt;fct&gt;  &lt;fct&gt;  &lt;fct&gt;  &lt;fct&gt;  &lt;fct&gt;  </span>
<span class="co">#&gt;  1 setosa setosa setosa setosa setosa </span>
<span class="co">#&gt;  2 setosa setosa setosa setosa setosa </span>
<span class="co">#&gt;  3 setosa setosa setosa setosa setosa </span>
<span class="co">#&gt;  4 setosa setosa setosa setosa setosa </span>
<span class="co">#&gt;  5 setosa setosa setosa setosa setosa </span>
<span class="co">#&gt;  6 setosa setosa setosa setosa setosa </span>
<span class="co">#&gt;  7 setosa setosa setosa setosa setosa </span>
<span class="co">#&gt;  8 setosa setosa setosa setosa setosa </span>
<span class="co">#&gt;  9 setosa setosa setosa setosa setosa </span>
<span class="co">#&gt; 10 setosa setosa setosa setosa setosa </span>
<span class="co">#&gt; # ... with 140 more rows</span></code></pre></div>
<p>Now we fit a final ensemble model on the <code>blended</code> data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ensemble &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/caret/topics/train">train</a></span>(Species <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> blended, <span class="dt">method =</span> <span class="st">'rf'</span>, <span class="dt">trControl =</span> control)
ensemble
<span class="co">#&gt; Random Forest </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 150 samples</span>
<span class="co">#&gt;   4 predictor</span>
<span class="co">#&gt;   3 classes: 'setosa', 'versicolor', 'virginica' </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; No pre-processing</span>
<span class="co">#&gt; Resampling: Cross-Validated (10 fold) </span>
<span class="co">#&gt; Summary of sample sizes: 120, 120, 120, 120, 120 </span>
<span class="co">#&gt; Resampling results across tuning parameters:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;   mtry  Accuracy  Kappa</span>
<span class="co">#&gt;   2     0.96      0.94 </span>
<span class="co">#&gt;   5     0.96      0.94 </span>
<span class="co">#&gt;   8     0.96      0.94 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Accuracy was used to select the optimal model using the largest value.</span>
<span class="co">#&gt; The final value used for the model was mtry = 2.</span></code></pre></div>
<p>Then we can add it to our leaderboard and see how it compares to the individual models. We’ll also take advantage of the <code>dir</code> argument of <code>board</code>. Saving this model to a new directory called <code>ensembles</code> allows a natural grouping of the baseline and ensemble models.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/board.html">board</a></span>(ensemble, <span class="dt">dir =</span> <span class="st">"ensembles"</span>)
<span class="co">#&gt; # A tibble: 5 x 13</span>
<span class="co">#&gt;    rank    id dir     model  metric score public method   num group index </span>
<span class="co">#&gt;   &lt;dbl&gt;  &lt;id&gt; &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;</span>
<span class="co">#&gt; 1    1.     2 models… glmnet Accur… 0.973     NA cv       10.    1. &lt;list…</span>
<span class="co">#&gt; 2    1.     4 models… knn    Accur… 0.973     NA cv       10.    1. &lt;list…</span>
<span class="co">#&gt; 3    3.     5 ensemb… rf     Accur… 0.960     NA cv       10.    1. &lt;list…</span>
<span class="co">#&gt; 4    4.     1 models… rf     Accur… 0.953     NA cv       10.    1. &lt;list…</span>
<span class="co">#&gt; 5    5.     3 models… rpart  Accur… 0.947     NA cv       10.    1. &lt;list…</span>
<span class="co">#&gt; # ... with 2 more variables: tune &lt;list&gt;, seeds &lt;list&gt;</span></code></pre></div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Source: <a href="https://dnc1994.com/2016/05/rank-10-percent-in-first-kaggle-competition-en/" class="uri">https://dnc1994.com/2016/05/rank-10-percent-in-first-kaggle-competition-en/</a><a href="#fnref1">↩</a></p></li>
</ol>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#ensembles">Ensembles</a></li>
      <li><a href="#the-task">The Task</a></li>
      <li><a href="#submodel-selection">Submodel Selection</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Tim Mastny.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
